name: Divary CI/CD

on:
  push:
    branches: [develop, main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Generate application-prod.yml
        run: |
          mkdir -p ./src/main/resources
          cat << 'EOF' > ./src/main/resources/application-prod.yml
          ${{ secrets.APPLICATION_PROD_YML }}
          EOF
        shell: bash

      - name: Grant permission to gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test --build-cache --parallel

      - name: Docker ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
        id: docker_meta
        run: echo "image_name=divary-app" >> $GITHUB_OUTPUT

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
          tags: ${{ steps.docker_meta.outputs.image_name }}:latest
          load: true # ì´ë¯¸ì§€ë¥¼ ë¡œì»¬ Docker ë°ëª¬ìœ¼ë¡œ ë¡œë“œ

      - name: Docker ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥
        run: docker save ${{ steps.docker_meta.outputs.image_name }}:latest -o divary-image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: divary-image-artifact
          path: divary-image.tar # tar íŒŒì¼ ì—…ë¡œë“œ

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: divary-image-artifact # ë¹Œë“œ ì¡ì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸ ì´ë¦„
          path: ./deploy-package

      - name: Deploy to EC2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          PROD_ENV: ${{ secrets.APPLICATION_PROD_ENV }}
        run: |
          # SSH í‚¤ ì„¤ì •
          cat << KEY_EOF > private_key.pem
          $EC2_SSH_KEY
          KEY_EOF
          chmod 600 private_key.pem

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat << ENV_EOF > .env
          $PROD_ENV
          ENV_EOF

          # Docker ì´ë¯¸ì§€(.tar)ì™€ í™˜ê²½ë³€ìˆ˜ íŒŒì¼(.env)ì„ EC2ë¡œ ì „ì†¡
          scp -i private_key.pem -o StrictHostKeyChecking=no ./deploy-package/divary-image.tar $EC2_USERNAME@$EC2_HOST:/home/$EC2_USERNAME/divary-image.tar
          scp -i private_key.pem -o StrictHostKeyChecking=no .env $EC2_USERNAME@$EC2_HOST:/home/$EC2_USERNAME/.env

          # EC2ì—ì„œ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
          ssh -i private_key.pem -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_HOST << 'EOF'
            set -e
            cd /home/$EC2_USERNAME

            # 1. tar íŒŒì¼ë¡œë¶€í„° Docker ì´ë¯¸ì§€ ë¡œë“œ
            docker load -i divary-image.tar

            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ì˜¤ë¥˜ ë¬´ì‹œ)
            docker stop divary-app || true
            docker rm divary-app || true

            # 3. ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # --env-file: .env íŒŒì¼ì˜ ëª¨ë“  ë³€ìˆ˜ë¥¼ ì»¨í…Œì´ë„ˆ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…
            # -d: ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
            # -p: í¬íŠ¸ í¬ì›Œë”© (í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ)
            # --restart always: ì„œë²„ ì¬ë¶€íŒ… ì‹œ ì»¨í…Œì´ë„ˆ ìë™ ì¬ì‹œì‘
            docker run \
              --name divary-app \
              -d \
              -p 8080:8080 \
              --restart always \
              --env-file .env \
              divary-app:latest

            # 4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ë³´)
            docker image prune -af

            echo "ğŸš€ Deployment Successful!"
          EOF
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f private_key.pem .env
